架設SharePoint Server失敗

# 0x0 前言
### CVE-2020-0932 Description  
A remote code execution vulnerability exists in Microsoft SharePoint when the software **fails to check the source markup of an application package**, aka 'Microsoft SharePoint Remote Code Execution Vulnerability'.

### Product Description
SharePoint is a **web-based collaborative platform** that **integrates with Microsoft Office**. Launched in 2001,[5] SharePoint is primarily sold as a **document management** and **storage system**, but the product is highly configurable and usage varies substantially among organizations.


* ()內為測試時使用之環境
* <>為可變動或需視使用環境變動的欄位
* `斜體字`為指令


# 0x1 前置需求
* 虛擬機軟體 (VMware Workstation 15.5.7)
* 攻擊機 (Windows Server 2012 R2)
* 受攻擊機 (Windows Server 2012 R2)


# 0x2 受攻擊機環境建置
### 搭建SharePoint Server
1. 參考 https://collab365.community/step-by-step-installation-of-sharepoint-2013-on-windows-server/ ，一直到Step 3安裝完SQL Server 2012 R2的步驟都一模一樣

2. [失敗] 但到Step 4.8時，出現了AppFabric無法安裝的問題  
![](image/2.2.PNG)  

查看log發現發出1603 error  
![](image/2.2_2.PNG)  
  
另外嘗試手動下載並安裝AppFabric，也無法安裝(同樣是error 1603)  
![](image/2.2_3.PNG)  
![](image/2.2_4.PNG)  

看起來問題就是出在error 1603，而Microsoft對於1603 error的原因與解決方法： https://docs.microsoft.com/zh-tw/troubleshoot/windows-server/application-management/msi-installation-error-1603 ，試過皆沒有用 ，權限都沒問題，也都是用管理權限執行的，因此完全沒有頭緒。


# 0x3 攻擊機環境建置


# 0x4 Snort/Suricata Rule
1. alert tcp $EXTERNAL_NET any -> $HTTP_SERVERS $HTTP_PORTS (msg:"SERVER-WEBAPP Microsoft SharePoint TypeConverter remote code execution attempt"; flow:to_server,established; content:"/_vti_bin/WebPartPages.asmx"; fast_pattern:only; http_uri; content:"RenderWebPartForEdit"; nocase; http_client_body; content:"System.Resources.ResXFileRef"; nocase; http_client_body; content:"System.Resources.ResourceSet"; nocase; http_client_body; metadata:policy balanced-ips drop, policy max-detect-ips drop, policy security-ips drop, service http; reference:cve,2020-0932; reference:url,portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-0932; classtype:attempted-user; sid:53866; rev:1;)


# 0x5 Reference
* https://www.anquanke.com/post/id/204315
* https://github.com/thezdi/PoC/tree/master/CVE-2020-0932
* https://www.youtube.com/watch?v=p8KPFkmQTwE&ab_channel=ZeroDayInitiative
* https://www.thezdi.com/blog/2020/4/28/cve-2020-0932-remote-code-execution-on-microsoft-sharepoint-using-typeconverters
* https://collab365.community/step-by-step-installation-of-sharepoint-2013-on-windows-server/


